<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindAR Demo - Image Tracking</title>
    
    <!-- MindAR and A-Frame Scripts -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        /* Ensure camera video is visible */
        a-scene {
            width: 100vw !important;
            height: 100vh !important;
        }
        
        /* Force video element to be visible */
        video {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        #instructions {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            max-width: 300px;
            z-index: 1000;
            font-size: 14px;
        }
        
        #instructions h3 {
            margin: 0 0 10px 0;
            color: #00ffff;
        }
        
        #instructions ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        #instructions .target-image {
            width: 150px;
            height: auto;
            border: 2px solid #00ffff;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        #toggle-instructions {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #00ffff;
            color: black;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
            font-weight: bold;
        }
        
        .hidden {
            display: none;
        }
        
        #status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
        }
        
        .status-ready { color: #00ff00; }
        .status-found { color: #ffff00; }
        .status-lost { color: #ff6600; }
    </style>
</head>
<body>
    <!-- Instructions Panel -->
    <div id="instructions">
        <h3>ðŸ“± MindAR Demo Instructions</h3>
        <ul>
            <li>Allow camera access when prompted</li>
            <li>Point your camera at the target image below</li>
            <li>You should see a 3D model appear on the image</li>
            <li>Move around to test tracking quality</li>
        </ul>
        
        <p><strong>Target Image:</strong></p>
        <img class="target-image" 
             src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.png" 
             alt="Target Image - Print this or display on another device">
        
        <p><small>ðŸ’¡ Print this image or display it on another device for best results. The image should be well-lit and flat.</small></p>
    </div>
    
    <button id="toggle-instructions" onclick="toggleInstructions()">Hide Info</button>
    
    <!-- Status Display -->
    <div id="status">
        <span id="status-text">Loading AR...</span>
    </div>

    <!-- A-Frame AR Scene -->
    <a-scene 
        mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind;
                     filterMinCF: 0.001; 
                     filterBeta: 1000;
                     warmupTolerance: 5;
                     missTolerance: 5;" 
        color-space="sRGB" 
        renderer="colorManagement: true, physicallyCorrectLights" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false"
        embedded
        style="width: 100%; height: 100%;"
        background="transparent: true";
        
        <!-- Assets -->
        <a-assets>
            <!-- Target card image with crossorigin -->
            <img id="card" 
                 crossorigin="anonymous"
                 src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.png" />
            
            <!-- 3D Model -->
            <a-asset-item id="avatarModel" 
                          crossorigin="anonymous"
                          src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/softmind/scene.gltf">
            </a-asset-item>
        </a-assets>

        <!-- Camera -->
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!-- AR Target Entity -->
        <a-entity id="target-entity" mindar-image-target="targetIndex: 0">
            
            <!-- 3D Model with Animation -->
            <a-gltf-model 
                id="avatar"
                src="#avatarModel"
                position="0 0 0.1" 
                scale="0.005 0.005 0.005"
                rotation="0 0 0"
                animation="property: rotation; 
                          to: 0 360 0; 
                          loop: true; 
                          dur: 8000; 
                          easing: linear">
            </a-gltf-model>
            
            <!-- Glowing base platform -->
            <a-cylinder 
                color="#00ffff" 
                opacity="0.6"
                position="0 -0.05 0"
                radius="0.3" 
                height="0.02"
                animation="property: material.opacity; 
                          to: 0.2; 
                          dir: alternate; 
                          loop: true; 
                          dur: 2000">
            </a-cylinder>
            
            <!-- Floating particles effect -->
            <a-sphere 
                color="#ffffff" 
                opacity="0.8"
                position="0.2 0.3 0.2" 
                radius="0.02"
                animation="property: position; 
                          to: -0.2 0.5 -0.2; 
                          dir: alternate; 
                          loop: true; 
                          dur: 3000; 
                          easing: easeInOutSine">
            </a-sphere>
            
            <a-sphere 
                color="#ffff00" 
                opacity="0.6"
                position="-0.15 0.2 0.15" 
                radius="0.015"
                animation="property: position; 
                          to: 0.15 0.4 -0.15; 
                          dir: alternate; 
                          loop: true; 
                          dur: 4000; 
                          easing: easeInOutSine">
            </a-sphere>
            
            <!-- Text label -->
            <a-text 
                value="MindAR Demo\nTracking Active!" 
                position="0 0.4 0" 
                align="center" 
                color="#00ffff"
                scale="0.3 0.3 0.3"
                animation="property: scale; 
                          to: 0.35 0.35 0.35; 
                          dir: alternate; 
                          loop: true; 
                          dur: 1500">
            </a-text>
            
        </a-entity>

        <!-- Ambient lighting -->
        <a-light type="ambient" color="#404040" intensity="0.4"></a-light>
        
        <!-- Directional light -->
        <a-light 
            type="directional" 
            position="1 1 1" 
            color="#ffffff" 
            intensity="0.8"
            light="castShadow: true">
        </a-light>

    </a-scene>

    <script>
        let instructionsVisible = true;
        
        function toggleInstructions() {
            const instructions = document.getElementById('instructions');
            const button = document.getElementById('toggle-instructions');
            
            if (instructionsVisible) {
                instructions.classList.add('hidden');
                button.textContent = 'Show Info';
                instructionsVisible = false;
            } else {
                instructions.classList.remove('hidden');
                button.textContent = 'Hide Info';
                instructionsVisible = true;
            }
        }
        
        // Status tracking
        const statusText = document.getElementById('status-text');
        const targetEntity = document.getElementById('target-entity');
        
        // Listen for AR events and camera debugging
        document.addEventListener('DOMContentLoaded', function() {
            
            // MindAR ready
            const sceneEl = document.querySelector('a-scene');
            
            // Debug camera access
            console.log('Starting camera debugging...');
            
            // Check if getUserMedia is available
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                console.log('getUserMedia is available');
                
                // Test camera access directly
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function(stream) {
                        console.log('Camera access successful:', stream);
                        
                        // Create a test video element to verify camera works
                        const testVideo = document.createElement('video');
                        testVideo.srcObject = stream;
                        testVideo.style.position = 'fixed';
                        testVideo.style.top = '0';
                        testVideo.style.left = '0';
                        testVideo.style.width = '200px';
                        testVideo.style.height = '150px';
                        testVideo.style.zIndex = '9999';
                        testVideo.style.border = '2px solid red';
                        testVideo.autoplay = true;
                        testVideo.muted = true;
                        
                        // Add test video to page temporarily
                        document.body.appendChild(testVideo);
                        
                        // Remove test video after 5 seconds
                        setTimeout(() => {
                            document.body.removeChild(testVideo);
                            stream.getTracks().forEach(track => track.stop());
                        }, 5000);
                        
                    })
                    .catch(function(error) {
                        console.error('Camera access failed:', error);
                        statusText.textContent = 'Camera Error: ' + error.message;
                        statusText.className = 'status-lost';
                    });
            } else {
                console.error('getUserMedia not supported');
                statusText.textContent = 'Camera not supported in this browser';
                statusText.className = 'status-lost';
            }
            
            sceneEl.addEventListener('renderstart', function() {
                statusText.textContent = 'AR Ready - Point camera at target image';
                statusText.className = 'status-ready';
                
                // Force video visibility after scene loads
                setTimeout(() => {
                    const videos = document.querySelectorAll('video');
                    console.log('Found video elements after renderstart:', videos.length);
                    videos.forEach((video, index) => {
                        console.log(`Video ${index} properties:`, {
                            display: video.style.display,
                            visibility: video.style.visibility,
                            opacity: video.style.opacity,
                            srcObject: video.srcObject,
                            videoWidth: video.videoWidth,
                            videoHeight: video.videoHeight,
                            readyState: video.readyState
                        });
                        
                        video.style.display = 'block';
                        video.style.visibility = 'visible';
                        video.style.opacity = '1';
                        video.style.zIndex = '-1';
                    });
                }, 1000);
            });
            
            // Additional camera initialization
            sceneEl.addEventListener('loaded', function() {
                console.log('Scene loaded - checking for camera elements');
                
                // Detailed debugging of all video/canvas elements
                setTimeout(() => {
                    const allVideos = document.querySelectorAll('video');
                    const allCanvas = document.querySelectorAll('canvas');
                    
                    console.log('=== CAMERA DEBUG INFO ===');
                    console.log('Video elements found:', allVideos.length);
                    console.log('Canvas elements found:', allCanvas.length);
                    
                    allVideos.forEach((video, index) => {
                        console.log(`Video ${index}:`, {
                            src: video.src,
                            srcObject: video.srcObject,
                            width: video.videoWidth,
                            height: video.videoHeight,
                            readyState: video.readyState,
                            paused: video.paused,
                            style: video.style.cssText
                        });
                    });
                    
                    allCanvas.forEach((canvas, index) => {
                        console.log(`Canvas ${index}:`, {
                            width: canvas.width,
                            height: canvas.height,
                            style: canvas.style.cssText
                        });
                    });
                    
                }, 2000);
            });
            
            // Target found
            targetEntity.addEventListener('targetFound', function() {
                statusText.textContent = 'Target Found! ðŸŽ¯';
                statusText.className = 'status-found';
                console.log('Target found!');
            });
            
            // Target lost  
            targetEntity.addEventListener('targetLost', function() {
                statusText.textContent = 'Target Lost - Keep image in view';
                statusText.className = 'status-lost';
                console.log('Target lost!');
            });
            
        });
        
        // Auto-hide instructions after 10 seconds
        setTimeout(function() {
            if (instructionsVisible) {
                toggleInstructions();
            }
        }, 10000);
        
        // Performance monitoring
        let frameCount = 0;
        let startTime = Date.now();
        
        setInterval(function() {
            frameCount++;
            if (frameCount % 60 === 0) {
                const fps = Math.round(60000 / (Date.now() - startTime));
                console.log(`FPS: ${fps}`);
                startTime = Date.now();
            }
        }, 16);
        
    </script>
</body>
</html>
